<?xml version="1.0" encoding="UTF-8"?>
    <source package="sun.security.rsa">
        <import package="java.math.BigInteger"/>
        <import package="java.util"/>
        <import package="java.security.SecureRandom"/>
        <import package="java.security.interfaces"/>
        <import package="javax.crypto.BadPaddingException"/>
        <import package="sun.security.jca.JCAUtil"/>
        <class name="RSACore" line="38">
            <comment line="76">
                temporary, used by RSACipher and RSAPadding. Move this somewhere else                
            </comment>
            <comment line="212">
                globally enable/disable use of blinding                
            </comment>
            <comment line="215">
                maximum number of times that we will use a set of blinding parameters                
            </comment>
            <comment line="216">
                value suggested by Paul Kocher (quoted by NSS)                
            </comment>
            <comment line="219">
                cache for blinding parameters. Map&lt;BigInteger, BlindingParameters&gt;                
            </comment>
            <comment line="220">
                use a weak hashmap so that cached values are automatically cleared                
            </comment>
            <comment line="221">
                when the modulus is GC&apos;ed                
            </comment>
            <javadoc line="38">
                Core of the RSA implementation. Has code to perform public and private key
                  RSA operations (with and without CRT for private key ops). Private CRT ops
                  also support blinding to twart timing attacks.
                  The code in this class only does the core RSA operation. Padding and
                  unpadding must be done externally.
                  Note: RSA keys should be at least 512 bits long                
                <since>
                    1.5                    
                </since>
                <author>
                    Andreas Sterbenz                    
                </author>
            </javadoc>
            <method name="RSACore" type="constructor" line="53">
                <comment line="54">
                    empty                    
                </comment>
            </method>
            <javadoc line="57">
                Return the number of bytes required to store the magnitude byte[] of
                  this BigInteger. Do not count a 0x00 byte toByteArray() would
                  prefix for 2&apos;s complement form.                
            </javadoc>
            <method name="getByteLength" type="int" line="62">
                <params>
                    <param name="b" type="BigInteger"/>
                </params>
                <declaration name="n" type="int" line="63"/>
            </method>
            <javadoc line="67">
                Return the number of bytes required to store the modulus of this
                  RSA key.                
            </javadoc>
            <method name="getByteLength" type="int" line="71">
                <params>
                    <param name="key" type="RSAKey"/>
                </params>
            </method>
            <method name="convert" type="byte[]" line="76">
                <params>
                    <param name="b" type="byte[]"/>
                    <param name="ofs" type="int"/>
                    <param name="len" type="int"/>
                </params>
                <scope line="77"/>
                <scope line="79">
                    <declaration name="t" type="byte[]" line="80"/>
                </scope>
            </method>
            <javadoc line="86">
                Perform an RSA public key operation.                
            </javadoc>
            <method name="rsa" type="byte[]" line="90">
                <params>
                    <param name="msg" type="byte[]"/>
                    <param name="key" type="RSAPublicKey"/>
                </params>
            </method>
            <javadoc line="94">
                Perform an RSA private key operation. Uses CRT if the key is a
                  CRT key.                
            </javadoc>
            <method name="rsa" type="byte[]" line="99">
                <params>
                    <param name="msg" type="byte[]"/>
                    <param name="key" type="RSAPrivateKey"/>
                </params>
                <scope line="100"/>
                <scope line="102"/>
            </method>
            <javadoc line="107">
                RSA public key ops and non-CRT private key ops. Simple modPow().                
            </javadoc>
            <method name="crypt" type="byte[]" line="111">
                <params>
                    <param name="msg" type="byte[]"/>
                    <param name="n" type="BigInteger"/>
                    <param name="exp" type="BigInteger"/>
                </params>
                <declaration name="m" type="BigInteger" line="112"/>
                <declaration name="c" type="BigInteger" line="113"/>
            </method>
            <javadoc line="117">
                RSA private key operations with CRT. Algorithm and variable naming
                  are taken from PKCS#1 v2.1, section 5.1.2.
                  The only difference is the addition of blinding to twart timing attacks.
                  This is described in the RSA Bulletin#2 (Jan 96) among other places.
                  This means instead of implementing RSA as
                  m = c ^ d mod n (or RSA in CRT variant)
                  we do
                  r  = random(0, n-1)
                  c&apos; = c   r^e  mod n
                  m&apos; = c&apos; ^ d    mod n (or RSA in CRT variant)
                  m  = m&apos;  r^-1 mod n (where r^-1 is the modular inverse of r mod n)
                  This works because r^(ed)  r^-1 = r  r^-1 = 1 (all mod n)
                  We do not generate new blinding parameters for each operation but reuse
                  them BLINDING_MAX_REUSE times (see definition below).                
            </javadoc>
            <method name="crtCrypt" type="byte[]" line="136">
                <params>
                    <param name="msg" type="byte[]"/>
                    <param name="key" type="RSAPrivateCrtKey"/>
                </params>
                <comment line="153">
                    m1 = c ^ dP mod p                    
                </comment>
                <comment line="155">
                    m2 = c ^ dQ mod q                    
                </comment>
                <comment line="158">
                    h = (m1 - m2) * qInv mod p                    
                </comment>
                <comment line="165">
                    m = m2 + q * h                    
                </comment>
                <declaration name="n" type="BigInteger" line="137"/>
                <declaration name="c" type="BigInteger" line="138"/>
                <declaration name="p" type="BigInteger" line="139"/>
                <declaration name="q" type="BigInteger" line="140"/>
                <declaration name="dP" type="BigInteger" line="141"/>
                <declaration name="dQ" type="BigInteger" line="142"/>
                <declaration name="qInv" type="BigInteger" line="143"/>
                <declaration name="params" type="BlindingParameters" line="145"/>
                <scope line="146"/>
                <scope line="149"/>
                <declaration name="m1" type="BigInteger" line="154"/>
                <declaration name="m2" type="BigInteger" line="156"/>
                <declaration name="mtmp" type="BigInteger" line="159"/>
                <scope line="160"/>
                <declaration name="h" type="BigInteger" line="163"/>
                <declaration name="m" type="BigInteger" line="166"/>
                <scope line="168"/>
            </method>
            <javadoc line="175">
                Parse the msg into a BigInteger and check against the modulus n.                
            </javadoc>
            <method name="parseMsg" type="BigInteger" line="179">
                <params>
                    <param name="msg" type="byte[]"/>
                    <param name="n" type="BigInteger"/>
                </params>
                <declaration name="m" type="BigInteger" line="180"/>
                <scope line="181"/>
            </method>
            <javadoc line="187">
                Return the encoding of this BigInteger that is exactly len bytes long.
                  Prefix/strip off leading 0x00 bytes if necessary.
                  Precondition: bi must fit into len bytes                
            </javadoc>
            <method name="toByteArray" type="byte[]" line="192">
                <params>
                    <param name="bi" type="BigInteger"/>
                    <param name="len" type="int"/>
                </params>
                <comment line="198">
                    BigInteger prefixed a 0x00 byte for 2&apos;s complement form, remove it                    
                </comment>
                <comment line="204">
                    must be smaller                    
                </comment>
                <declaration name="b" type="byte[]" line="193"/>
                <declaration name="n" type="int" line="194"/>
                <scope line="195"/>
                <scope line="199">
                    <declaration name="t" type="byte[]" line="200"/>
                </scope>
                <declaration name="t" type="byte[]" line="206"/>
            </method>
            <declaration name="ENABLE_BLINDING" type="boolean" line="212"/>
            <declaration name="BLINDING_MAX_REUSE" type="int" line="216"/>
            <declaration name="blindingCache" type="Map&lt;BigInteger,BlindingParameters&gt;" line="221"/>
            <class name="BlindingParameters" line="224">
                <comment line="236">
                    e (RSA public exponent)                    
                </comment>
                <comment line="238">
                    r ^ e mod n                    
                </comment>
                <comment line="240">
                    inverse of r mod n                    
                </comment>
                <comment line="242">
                    how many more times this parameter object can be used                    
                </comment>
                <javadoc line="224">
                    Set of blinding parameters for a given RSA key.
                      The RSA modulus is usually unique, so we index by modulus in
                      blindingCache. However, to protect against the unlikely case of two
                      keys sharing the same modulus, we also store the public exponent.
                      This means we cannot cache blinding parameters for multiple keys that
                      share the same modulus, but since sharing moduli is fundamentally broken
                      an insecure, this does not matter.                    
                </javadoc>
                <declaration name="e" type="BigInteger" line="236"/>
                <declaration name="re" type="BigInteger" line="238"/>
                <declaration name="rInv" type="BigInteger" line="240"/>
                <declaration name="remainingUses" type="int" line="242"/>
                <method name="BlindingParameters" type="constructor" line="243">
                    <params>
                        <param name="e" type="BigInteger"/>
                        <param name="re" type="BigInteger"/>
                        <param name="rInv" type="BigInteger"/>
                    </params>
                    <comment line="247">
                        initialize remaining uses, subtract current use now                        
                    </comment>
                </method>
                <method name="valid" type="boolean" line="250">
                    <params>
                        <param name="e" type="BigInteger"/>
                    </params>
                    <declaration name="k" type="int" line="251"/>
                </method>
            </class>
            <javadoc line="256">
                Return valid RSA blinding parameters for the given private key.
                  Use cached parameters if available. If not, generate new parameters
                  and cache.                
            </javadoc>
            <method name="getBlindingParameters" type="BlindingParameters" line="262">
                <params>
                    <param name="key" type="RSAPrivateCrtKey"/>
                </params>
                <comment line="266">
                    we release the lock between get() and put()                    
                </comment>
                <comment line="267">
                    that means threads might concurrently generate new blinding                    
                </comment>
                <comment line="268">
                    parameters for the same modulus. this is only a slight waste                    
                </comment>
                <comment line="269">
                    of cycles and seems preferable in terms of scalability                    
                </comment>
                <comment line="270">
                    to locking out all threads while generating new parameters                    
                </comment>
                <declaration name="modulus" type="BigInteger" line="263"/>
                <declaration name="e" type="BigInteger" line="264"/>
                <declaration name="params" type="BlindingParameters" line="265"/>
                <scope line="271"/>
                <scope line="274"/>
                <declaration name="len" type="int" line="277"/>
                <declaration name="random" type="SecureRandom" line="278"/>
                <declaration name="r" type="BigInteger" line="279"/>
                <declaration name="re" type="BigInteger" line="280"/>
                <declaration name="rInv" type="BigInteger" line="281"/>
                <scope line="283"/>
            </method>
        </class>
    </source>