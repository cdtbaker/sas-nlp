<?xml version="1.0" encoding="UTF-8"?>
    <source package="sun.security.jgss">
        <import package="org.ietf.jgss.MessageProp"/>
        <import package="java.util.LinkedList"/>
        <class name="TokenTracker" line="31">
            <javadoc line="31">
                A utility class that implements a number list that keeps track of which
                  tokens have arrived by storing their token numbers in the list. It helps
                  detect old tokens, out of sequence tokens, and duplicate tokens.
                  Each element of the list is an interval [a, b]. Its existence in the
                  list implies that all token numbers in the range a, a+1, ..., b-1, b
                  have arrived. Gaps in arrived token numbers are represented by the
                  numbers that fall in between two elements of the list. eg. {[a,b],
                  [c,d]} indicates that the token numbers b+1, ..., c-1 have not arrived
                  yet.
                  The maximum number of intervals that we keep track of is
                  MAX_INTERVALS. Thus if there are too many gaps, then some of the older
                  sequence numbers are deleted from the list. The earliest sequence number
                  that exists in the list is the windowStart. The next expected sequence
                  number, or expectedNumber, is one greater than the latest sequence
                  number in the list.
                  The list keeps track the first token number that should have arrived
                  (initNumber) so that it is able to detect if certain numbers occur after
                  the first valid token number but before windowStart. That would happen
                  if the number of elements (intervals) exceeds MAX_INTERVALS and some
                  initial elements had  to be deleted.
                  The working of the list is optimized for the normal case where the
                  tokens arrive in sequence.                
                <author>
                    Mayank Upadhyay                    
                </author>
                <since>
                    1.4                    
                </since>
            </javadoc>
            <declaration name="MAX_INTERVALS" type="int" line="64"/>
            <declaration name="initNumber" type="int" line="66"/>
            <declaration name="windowStart" type="int" line="67"/>
            <declaration name="expectedNumber" type="int" line="68"/>
            <declaration name="windowStartIndex" type="int" line="70"/>
            <declaration name="list" type="LinkedList&lt;Entry&gt;" line="72"/>
            <method name="TokenTracker" type="constructor" line="74">
                <params>
                    <param name="initNumber" type="int"/>
                </params>
                <comment line="80">
                    Make an entry with one less than the expected first token                    
                </comment>
                <declaration name="entry" type="Entry" line="81"/>
            </method>
            <javadoc line="86">
                Returns the index for the entry into which this number will fit. If
                  there is none, it returns the index of the last interval
                  which precedes this number. It returns -1 if the number needs to be
                  a in a new interval ahead of the whole list.                
            </javadoc>
            <method name="getIntervalIndex" type="int" line="92">
                <params>
                    <param name="number" type="int"/>
                </params>
                <comment line="95">
                    Start from the rear to optimize for the normal case                    
                </comment>
                <declaration name="entry" type="Entry" line="93"/>
                <declaration name="i" type="int" line="94"/>
                <scope line="96"/>
            </method>
            <javadoc line="104">
                Sets the sequencing and replay information for the given token
                  number.
                  The following represents the number line with positions of
                  initNumber, windowStart, expectedNumber marked on it. Regions in
                  between them show the different sequencing and replay state
                  possibilites for tokens that fall in there.
                  (1)      windowStart
                  initNumber               expectedNumber
                  |                           |
                  ---|---------------------------|---
                  GAP |    DUP/UNSEQ              | GAP
                  (2)       initNumber   windowStart   expectedNumber
                  |               |              |
                  ---|---------------|--------------|---
                  GAP |      OLD      |  DUP/UNSEQ   | GAP
                  (3)                                windowStart
                  expectedNumber            initNumber
                  |                           |
                  ---|---------------------------|---
                  DUP/UNSEQ |           GAP             | DUP/UNSEQ
                  (4)      expectedNumber    initNumber   windowStart
                  |               |              |
                  ---|---------------|--------------|---
                  DUP/UNSEQ |        GAP    |    OLD       | DUP/UNSEQ
                  (5)      windowStart   expectedNumber    initNumber
                  |               |              |
                  ---|---------------|--------------|---
                  OLD |    DUP/UNSEQ  |     GAP      | OLD
                  (This analysis leaves out the possibility that expectedNumber passes
                  initNumber after wrapping around. That may be added later.)                
            </javadoc>
            <method name="getProps" type="void" line="150">
                <params>
                    <param name="number" type="int"/>
                    <param name="prop" type="MessageProp"/>
                </params>
                <comment line="157">
                    System.out.println(&quot;\n\n==========&quot;);                    
                </comment>
                <comment line="158">
                    System.out.println(&quot;TokenTracker.getProps(): number=&quot; + number);                    
                </comment>
                <comment line="159">
                    System.out.println(toString());                    
                </comment>
                <comment line="166">
                    Optimize for the expected case:                    
                </comment>
                <comment line="172">
                    Next trivial case is to check for duplicate                    
                </comment>
                <comment line="179">
                    Cases (1) and (2)                    
                </comment>
                <comment line="192">
                    Cases (3), (4) and (5)                    
                </comment>
                <comment line="224">
                    System.out.println(&quot;Leaving with state:&quot;);                    
                </comment>
                <comment line="225">
                    System.out.println(toString());                    
                </comment>
                <comment line="226">
                    System.out.println(&quot;==========\n&quot;);                    
                </comment>
                <declaration name="gap" type="boolean" line="152"/>
                <declaration name="old" type="boolean" line="153"/>
                <declaration name="unsequenced" type="boolean" line="154"/>
                <declaration name="duplicate" type="boolean" line="155"/>
                <declaration name="pos" type="int" line="161"/>
                <declaration name="entry" type="Entry" line="162"/>
                <scope line="168"/>
                <scope line="170">
                    <scope line="175">
                        <scope line="177">
                            <scope line="181"/>
                            <scope line="183"/>
                            <scope line="185"/>
                            <scope line="187"/>
                        </scope>
                        <scope line="190">
                            <scope line="194">
                                <scope line="195"/>
                                <scope line="197">
                                    <scope line="198"/>
                                </scope>
                                <scope line="202"/>
                            </scope>
                            <scope line="205"/>
                            <scope line="207"/>
                        </scope>
                    </scope>
                </scope>
            </method>
            <javadoc line="229">
                Adds the number to the list just after the entry that is currently
                  at position prevEntryPos. If prevEntryPos is -1, then the number
                  will begin a new interval at the front of the list.                
            </javadoc>
            <method name="add" type="void" line="234">
                <params>
                    <param name="number" type="int"/>
                    <param name="prevEntryPos" type="int"/>
                </params>
                <comment line="246">
                    Can this number simply be added to the previous interval?                    
                </comment>
                <comment line="253">
                    Now check the interval that follows this number                    
                </comment>
                <comment line="259">
                    Can this number simply be added to the next interval?                    
                </comment>
                <comment line="264">
                    Merge the two entries                    
                </comment>
                <comment line="267">
                    Index of any entry following this gets decremented                    
                </comment>
                <comment line="278">
                    At this point we know that the number will start a new interval
                     which needs to be added to the list. We might have to recyle an
                     older entry in the list.                    
                </comment>
                <comment line="287">
                    due to the insertion which will happen                    
                </comment>
                <comment line="289">
                    Delete the entry that marks the start of the current window.
                     The marker will automatically point to the next entry in the
                     list when this happens. If the current entry is at the end
                     of the list then set the marker to the start of the list.                    
                </comment>
                <comment line="305">
                    due to the deletion that just happened                    
                </comment>
                <comment line="307">
                    If the start of the current window just moved from the
                     end of the list to the front of the list, and if the new
                     entry will be added to the front of the list, then
                     the new entry is the actual window start.
                     eg, Consider { [-10, -8], ..., [-6, -3], [3, 9]}. In
                     this list, suppose the element [3, 9] is the start of
                     the window and has to be deleted to make place to add
                     [-12, -12]. The resultant list will be
                     {[-12, -12], [-10, -8], ..., [-6, -3]} and the new start
                     of the window should be the element [-12, -12], not
                     [-10, -8] which succeeded [3, 9] in the old list.                    
                </comment>
                <comment line="321">
                    windowStartIndex is 0 at this point                    
                </comment>
                <comment line="323">
                    The new entry is going to the front                    
                </comment>
                <comment line="326">
                    due to the insertion which will happen:                    
                </comment>
                <comment line="332">
                    Finally we are ready to actually add to the list at index                    
                </comment>
                <comment line="333">
                    &apos;prevEntryPos+1&apos;                    
                </comment>
                <declaration name="entry" type="Entry" line="236"/>
                <declaration name="entryBefore" type="Entry" line="237"/>
                <declaration name="entryAfter" type="Entry" line="238"/>
                <declaration name="appended" type="boolean" line="240"/>
                <declaration name="prepended" type="boolean" line="241"/>
                <scope line="243">
                    <scope line="247"/>
                </scope>
                <declaration name="nextEntryPos" type="int" line="255"/>
                <scope line="256">
                    <scope line="260">
                        <scope line="261"/>
                        <scope line="263"/>
                    </scope>
                </scope>
                <scope line="284"/>
                <scope line="288">
                    <declaration name="oldWindowStartIndex" type="int" line="295"/>
                    <scope line="304"/>
                    <scope line="306">
                        <scope line="320"/>
                        <scope line="325"/>
                    </scope>
                </scope>
            </method>
            <method name="toString" type="String" line="338">
                <declaration name="buf" type="StringBuffer" line="339"/>
                <scope line="345"/>
            </method>
            <class name="Entry" line="354">
                <javadoc line="354">
                    An entry in the list that represents the sequence of received
                      tokens. Each entry is actaully an interval of numbers, all of which
                      have been received.                    
                </javadoc>
                <declaration name="start" type="int" line="361"/>
                <declaration name="end" type="int" line="362"/>
                <method name="Entry" type="constructor" line="364">
                    <params>
                        <param name="number" type="int"/>
                    </params>
                </method>
                <javadoc line="369">
                    Returns -1 if this interval represented by this entry precedes
                      the number, 0 if the the number is contained in the interval,
                      and -1 if the interval occurs after the number.                    
                </javadoc>
                <method name="compareTo" type="int" line="374">
                    <params>
                        <param name="number" type="int"/>
                    </params>
                </method>
                <method name="contains" type="boolean" line="383">
                    <params>
                        <param name="number" type="int"/>
                    </params>
                </method>
                <method name="append" type="void" line="388">
                    <params>
                        <param name="number" type="int"/>
                    </params>
                </method>
                <method name="setInterval" type="void" line="393">
                    <params>
                        <param name="start" type="int"/>
                        <param name="end" type="int"/>
                    </params>
                </method>
                <method name="setEnd" type="void" line="398">
                    <params>
                        <param name="end" type="int"/>
                    </params>
                </method>
                <method name="setStart" type="void" line="402">
                    <params>
                        <param name="start" type="int"/>
                    </params>
                </method>
                <method name="getStart" type="int" line="406"/>
                <method name="getEnd" type="int" line="410"/>
                <method name="toString" type="String" line="414"/>
            </class>
        </class>
    </source>