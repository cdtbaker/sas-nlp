<?xml version="1.0" encoding="UTF-8"?>
    <source package="sun.security.jgss.krb5">
        <import package="org.ietf.jgss"/>
        <import package="sun.security.jgss"/>
        <import package="sun.security.krb5"/>
        <import package="java.io.InputStream"/>
        <import package="java.io.OutputStream"/>
        <import package="java.io.IOException"/>
        <import package="java.io.ByteArrayInputStream"/>
        <import package="java.security.GeneralSecurityException"/>
        <import package="java.security.MessageDigest"/>
        <class name="MessageToken" line="38">
            <extends class="Krb5Token"/>
            <comment line="79">
                                
            </comment>
            <comment line="88">
                Signing algorithm values (for the SNG_ALG field)                
            </comment>
            <comment line="90">
                From RFC 1964                
            </comment>
            <comment line="91">
                                
            </comment>
            <comment line="94">
                                
            </comment>
            <comment line="97">
                From draft-raeburn-cat-gssapi-krb5-3des-00                
            </comment>
            <comment line="98">
                                
            </comment>
            <comment line="101">
                Sealing algorithm values (for the SEAL_ALG field)                
            </comment>
            <comment line="103">
                RFC 1964                
            </comment>
            <comment line="109">
                                
            </comment>
            <comment line="112">
                From draft-raeburn-cat-gssapi-krb5-3des-00                
            </comment>
            <comment line="121">
                draft draft-brezak-win2k-krb-rc4-hmac-04.txt                
            </comment>
            <comment line="141">
                                
            </comment>
            <comment line="541">
                Obtains the conext key that is associated with this token.
                 @return the context key                
            </comment>
            <comment line="545">
                public final byte[] getContextKey() {
                return contextKey;
                }                
            </comment>
            <comment line="564">
                ******************************************* //
                  I N N E R    C L A S S E S    F O L L O W
                 *******************************************                
            </comment>
            <comment line="714">
                end of class MessageTokenHeader                
            </comment>
            <javadoc line="38">
                This class is a base class for other token definitions that pertain to
                  per-message GSS-API calls. Conceptually GSS-API has two types of
                  per-message tokens: WrapToken and MicToken. They differ in the respect
                  that a WrapToken carries additional plaintext or ciphertext application
                  data besides just the sequence number and checksum. This class
                  encapsulates the commonality in the structure of the WrapToken and the
                  MicToken. This structure can be represented as:
                  &lt;p&gt;
                  &lt;pre&gt;
                  0..1           TOK_ID          Identification field.
                  01 01 - Mic token
                  02 01 - Wrap token
                  2..3           SGN_ALG         Checksum algorithm indicator.
                  00 00 - DES MAC MD5
                  01 00 - MD2.5
                  02 00 - DES MAC
                  04 00 - HMAC SHA1 DES3-KD
                  11 00 - RC4-HMAC
                  4..5           SEAL_ALG        ff ff - none
                  00 00 - DES
                  02 00 - DES3-KD
                  10 00 - RC4-HMAC
                  6..7           Filler          Contains ff ff
                  8..15          SND_SEQ         Encrypted sequence number field.
                  16..s+15       SGN_CKSUM       Checksum of plaintext padded data,
                  calculated according to algorithm
                  specified in SGN_ALG field.
                  s+16..last     Data            encrypted or plaintext padded data
                  &lt;/pre&gt;
                  Where &quot;s&quot; indicates the size of the checksum.
                  &lt;p&gt;
                  As always, this is preceeded by a GSSHeader.                
                <author>
                    Mayank Upadhyay                    
                </author>
                <author>
                    Ram Marti                    
                </author>
                <see>
                    sun.security.jgss.GSSHeader                    
                </see>
            </javadoc>
            <declaration name="TOKEN_NO_CKSUM_SIZE" type="int" line="79"/>
            <declaration name="FILLER" type="int" line="81"/>
            <javadoc line="81">
                Filler data as defined in the specification of the Kerberos v5 GSS-API
                  Mechanism.                
            </javadoc>
            <declaration name="SGN_ALG_DES_MAC_MD5" type="int" line="91"/>
            <declaration name="SGN_ALG_DES_MAC" type="int" line="94"/>
            <declaration name="SGN_ALG_HMAC_SHA1_DES3_KD" type="int" line="98"/>
            <declaration name="SEAL_ALG_NONE" type="int" line="103"/>
            <javadoc line="103">
                A value for the SEAL_ALG field that indicates that no encryption was
                  used.                
            </javadoc>
            <declaration name="SEAL_ALG_DES" type="int" line="109"/>
            <declaration name="SEAL_ALG_DES3_KD" type="int" line="112"/>
            <javadoc line="112">
                Use DES3-KD sealing algorithm. (draft-raeburn-cat-gssapi-krb5-3des-00)
                  This algorithm uses triple-DES with key derivation, with a usage
                  value KG_USAGE_SEAL.  Padding is still to 8-byte multiples, and the
                  IV for encrypting application data is zero.                
            </javadoc>
            <declaration name="SEAL_ALG_ARCFOUR_HMAC" type="int" line="121"/>
            <declaration name="SGN_ALG_HMAC_MD5_ARCFOUR" type="int" line="122"/>
            <declaration name="TOKEN_ID_POS" type="int" line="124"/>
            <declaration name="SIGN_ALG_POS" type="int" line="125"/>
            <declaration name="SEAL_ALG_POS" type="int" line="126"/>
            <declaration name="seqNumber" type="int" line="128"/>
            <declaration name="confState" type="boolean" line="130"/>
            <declaration name="initiator" type="boolean" line="131"/>
            <declaration name="tokenId" type="int" line="133"/>
            <declaration name="gssHeader" type="GSSHeader" line="134"/>
            <declaration name="tokenHeader" type="MessageTokenHeader" line="135"/>
            <declaration name="checksum" type="byte[]" line="136"/>
            <declaration name="encSeqNumber" type="byte[]" line="137"/>
            <declaration name="seqNumberData" type="byte[]" line="138"/>
            <declaration name="cipherHelper" type="CipherHelper" line="141"/>
            <javadoc line="144">
                Constructs a MessageToken from a byte array. If there are more bytes
                  in the array than needed, the extra bytes are simply ignroed.                
                <param>
                    tokenId the token id that should be contained in this token as
                      it is read.                    
                </param>
                <param>
                    context the Kerberos context associated with this token                    
                </param>
                <param>
                    tokenBytes the byte array containing the token                    
                </param>
                <param>
                    tokenOffset the offset where the token begins                    
                </param>
                <param>
                    tokenLen the length of the token                    
                </param>
                <param>
                    prop the MessageProp structure in which the properties of the
                      token should be stored.                    
                </param>
                <throws>
                    GSSException if there is a problem parsing the token                    
                </throws>
            </javadoc>
            <method name="MessageToken" type="constructor" line="160">
                <params>
                    <param name="tokenId" type="int"/>
                    <param name="context" type="Krb5Context"/>
                    <param name="tokenBytes" type="byte[]"/>
                    <param name="tokenOffset" type="int"/>
                    <param name="tokenLen" type="int"/>
                    <param name="prop" type="MessageProp"/>
                </params>
            </method>
            <javadoc line="166">
                Constructs a MessageToken from an InputStream. Bytes will be read on
                  demand and the thread might block if there are not enough bytes to
                  complete the token.                
                <param>
                    tokenId the token id that should be contained in this token as
                      it is read.                    
                </param>
                <param>
                    context the Kerberos context associated with this token                    
                </param>
                <param>
                    is the InputStream from which to read                    
                </param>
                <param>
                    prop the MessageProp structure in which the properties of the
                      token should be stored.                    
                </param>
                <throws>
                    GSSException if there is a problem reading from the
                      InputStream or parsing the token                    
                </throws>
            </javadoc>
            <method name="MessageToken" type="constructor" line="181">
                <params>
                    <param name="tokenId" type="int"/>
                    <param name="context" type="Krb5Context"/>
                    <param name="is" type="InputStream"/>
                    <param name="prop" type="MessageProp"/>
                </params>
                <comment line="201">
                    debug(&quot;\n\tRead EncSeq#=&quot; +
                     getHexBytes(encSeqNumber, encSeqNumber.length));                    
                </comment>
                <comment line="207">
                    debug(&quot;\n\tRead checksum=&quot; +
                     getHexBytes(checksum, checksum.length));
                     debug(&quot;\nLeaving MessageToken.Cons\n&quot;);                    
                </comment>
                <scope line="184">
                    <scope line="187"/>
                    <scope line="191"/>
                </scope>
                <scope line="210"/>
            </method>
            <javadoc line="216">
                Used to obtain the GSSHeader that was at the start of this
                  token.                
            </javadoc>
            <method name="getGSSHeader" type="GSSHeader" line="220"/>
            <javadoc line="224">
                Used to obtain the token id that was contained in this token.                
                <return>
                    the token id in the token                    
                </return>
            </javadoc>
            <method name="getTokenId" type="int" line="228"/>
            <javadoc line="232">
                Used to obtain the encrypted sequence number in this token.                
                <return>
                    the encrypted sequence number in the token                    
                </return>
            </javadoc>
            <method name="getEncSeqNumber" type="byte[]" line="236"/>
            <javadoc line="240">
                Used to obtain the checksum that was contained in this token.                
                <return>
                    the checksum in the token                    
                </return>
            </javadoc>
            <method name="getChecksum" type="byte[]" line="244"/>
            <javadoc line="248">
                Used to determine if this token contains any encrypted data.                
                <return>
                    true if it contains any encrypted data, false if there is only
                      plaintext data or if there is no data.                    
                </return>
            </javadoc>
            <method name="getConfState" type="boolean" line="253"/>
            <javadoc line="257">
                Generates the checksum field and the encrypted sequence number
                  field. The encrypted sequence number uses the 8 bytes of the checksum
                  as an initial vector in a fixed DesCbc algorithm.                
                <param>
                    prop the MessageProp structure that determines what sort of
                      checksum and sealing algorithm should be used. The lower byte
                      of qop determines the checksum algorithm while the upper byte
                      determines the signing algorithm.
                      Checksum values are:
                      0 - default (DES_MAC)
                      1 - MD5
                      2 - DES_MD5
                      3 - DES_MAC
                      4 - HMAC_SHA1
                      Sealing values are:
                      0 - default (DES)
                      1 - DES
                      2 - DES3-KD                    
                </param>
                <param>
                    optionalHeader an optional header that will be processed first
                      during  checksum calculation                    
                </param>
                <param>
                    data the application data to checksum                    
                </param>
                <param>
                    offset the offset where the data starts                    
                </param>
                <param>
                    len the length of the data                    
                </param>
                <param>
                    optionalTrailer an optional trailer that will be processed
                      last during checksum calculation. e.g., padding that should be
                      appended to the application data                    
                </param>
                <throws>
                    GSSException if an error occurs in the checksum calculation or
                      encryption sequence number calculation.                    
                </throws>
            </javadoc>
            <method name="genSignAndSeqNumber" type="void" line="295">
                <params>
                    <param name="prop" type="MessageProp"/>
                    <param name="optionalHeader" type="byte[]"/>
                    <param name="data" type="byte[]"/>
                    <param name="offset" type="int"/>
                    <param name="len" type="int"/>
                    <param name="optionalTrailer" type="byte[]"/>
                </params>
                <comment line="298">
                    debug(&quot;Inside MessageToken.genSignAndSeqNumber:\n&quot;);                    
                </comment>
                <comment line="310">
                    Create a token header with the correct sign and seal algorithm
                     values.                    
                </comment>
                <comment line="315">
                    Calculate SGN_CKSUM                    
                </comment>
                <comment line="320">
                    debug(&quot;\n\tCalc checksum=&quot; +
                     getHexBytes(checksum, checksum.length));                    
                </comment>
                <comment line="323">
                    Calculate SND_SEQ                    
                </comment>
                <comment line="327">
                    When using this RC4 based encryption type, the sequence number is
                     always sent in big-endian rather than little-endian order.                    
                </comment>
                <comment line="332">
                    for all other etypes                    
                </comment>
                <comment line="344">
                    debug(&quot;\n\tCalc seqNum=&quot; +
                        getHexBytes(seqNumberData, seqNumberData.length));
                     debug(&quot;\n\tCalc encSeqNum=&quot; +
                        getHexBytes(encSeqNumber, encSeqNumber.length));                    
                </comment>
                <declaration name="qop" type="int" line="299"/>
                <scope line="300"/>
                <scope line="305"/>
                <scope line="328"/>
                <scope line="330"/>
                <scope line="334"/>
            </method>
            <javadoc line="349">
                Verifies that the checksum field and sequence number direction bytes
                  are valid and consistent with the application data.                
                <param>
                    optionalHeader an optional header that will be processed first
                      during checksum calculation.                    
                </param>
                <param>
                    data the application data                    
                </param>
                <param>
                    offset the offset where the data begins                    
                </param>
                <param>
                    len the length of the application data                    
                </param>
                <param>
                    optionalTrailer an optional trailer that will be processed last
                      during checksum calculation. e.g., padding that should be appended to
                      the application data                    
                </param>
                <throws>
                    GSSException if an error occurs in the checksum calculation or
                      encryption sequence number calculation.                    
                </throws>
            </javadoc>
            <method name="verifySignAndSeqNumber" type="boolean" line="370">
                <params>
                    <param name="optionalHeader" type="byte[]"/>
                    <param name="data" type="byte[]"/>
                    <param name="offset" type="int"/>
                    <param name="len" type="int"/>
                    <param name="optionalTrailer" type="byte[]"/>
                </params>
                <comment line="372">
                    debug(&quot;\tIn verifySign:\n&quot;);                    
                </comment>
                <comment line="374">
                    debug(&quot;\t\tchecksum:   [&quot; + getHexBytes(checksum) + &quot;]\n&quot;);                    
                </comment>
                <comment line="379">
                    debug(&quot;\t\tmychecksum: [&quot; + getHexBytes(myChecksum) +&quot;]\n&quot;);
                     debug(&quot;\t\tchecksum:   [&quot; + getHexBytes(checksum) + &quot;]\n&quot;);                    
                </comment>
                <comment line="387">
                    debug(&quot;\t\tencSeqNumber:   [&quot; + getHexBytes(encSeqNumber)
                      + &quot;]\n&quot;);
                     debug(&quot;\t\tseqNumberData:   [&quot; + getHexBytes(seqNumberData)
                      + &quot;]\n&quot;);                    
                </comment>
                <comment line="392">
                    The token from the initiator has direction bytes 0x00 and
                     the token from the acceptor has direction bytes 0xff.                    
                </comment>
                <comment line="398">
                    Received token from acceptor                    
                </comment>
                <declaration name="myChecksum" type="byte[]" line="375"/>
                <scope line="381">
                    <declaration name="directionByte" type="byte" line="395"/>
                </scope>
            </method>
            <method name="getSequenceNumber" type="int" line="410">
                <declaration name="sequenceNum" type="int" line="411"/>
                <scope line="412"/>
                <scope line="414"/>
            </method>
            <javadoc line="420">
                Computes the checksum based on the algorithm stored in the
                  tokenHeader.                
                <param>
                    optionalHeader an optional header that will be processed first
                      during checksum calculation.                    
                </param>
                <param>
                    data the application data                    
                </param>
                <param>
                    offset the offset where the data begins                    
                </param>
                <param>
                    len the length of the application data                    
                </param>
                <param>
                    optionalTrailer an optional trailer that will be processed last
                      during checksum calculation. e.g., padding that should be appended to
                      the application data                    
                </param>
                <throws>
                    GSSException if an error occurs in the checksum calculation.                    
                </throws>
            </javadoc>
            <method name="getChecksum" type="byte[]" line="440">
                <params>
                    <param name="optionalHeader" type="byte[]"/>
                    <param name="data" type="byte[]"/>
                    <param name="offset" type="int"/>
                    <param name="len" type="int"/>
                    <param name="optionalTrailer" type="byte[]"/>
                </params>
                <comment line="443">
                    debug(&quot;Will do getChecksum:\n&quot;);                    
                </comment>
                <comment line="445">
                    For checksum calculation the token header bytes i.e., the first 8
                     bytes following the GSSHeader, are logically prepended to the
                     application data to bind the data to this particular token.
                    
                     Note: There is no such requirement wrt adding padding to the
                     application data for checksumming, although the cryptographic
                     algorithm used might itself apply some padding.                    
                </comment>
                <declaration name="tokenHeaderBytes" type="byte[]" line="454"/>
                <declaration name="existingHeader" type="byte[]" line="455"/>
                <declaration name="checksumDataHeader" type="byte[]" line="456"/>
                <scope line="458"/>
            </method>
            <javadoc line="473">
                Constructs an empty MessageToken for the local context to send to
                  the peer. It also increments the local sequence number in the
                  Krb5Context instance it uses after obtaining the object lock for
                  it.                
                <param>
                    tokenId the token id that should be contained in this token                    
                </param>
                <param>
                    context the Kerberos context associated with this token                    
                </param>
            </javadoc>
            <method name="MessageToken" type="constructor" line="482">
                <params>
                    <param name="tokenId" type="int"/>
                    <param name="context" type="Krb5Context"/>
                </params>
                <comment line="484">
                    debug(&quot;\n============================&quot;);
                    debug(&quot;\nMySessionKey=&quot; +
                    getHexBytes(context.getMySessionKey().getBytes()));
                    debug(&quot;\nPeerSessionKey=&quot; +
                    getHexBytes(context.getPeerSessionKey().getBytes()));
                    debug(&quot;\n============================\n&quot;);                    
                </comment>
            </method>
            <method name="init" type="void" line="495">
                <params>
                    <param name="tokenId" type="int"/>
                    <param name="context" type="Krb5Context"/>
                </params>
                <comment line="498">
                    Just for consistency check in Wrap                    
                </comment>
                <comment line="504">
                    debug(&quot;In MessageToken.Cons&quot;);                    
                </comment>
            </method>
            <javadoc line="506">
                Encodes a GSSHeader and this token onto an OutputStream.                
                <param>
                    os the OutputStream to which this should be written                    
                </param>
                <throws>
                    GSSException if an error occurs while writing to the OutputStream                    
                </throws>
            </javadoc>
            <method name="encode" type="void" line="512">
                <params>
                    <param name="os" type="OutputStream"/>
                </params>
                <comment line="517">
                    debug(&quot;Writing seqNumber: &quot; + getHexBytes(encSeqNumber));                    
                </comment>
                <comment line="519">
                    debug(&quot;Writing checksum: &quot; + getHexBytes(checksum));                    
                </comment>
            </method>
            <javadoc line="522">
                Obtains the size of this token. Note that this excludes the size of
                  the GSSHeader.                
                <return>
                    token size                    
                </return>
            </javadoc>
            <method name="getKrb5TokenSize" type="int" line="527"/>
            <method name="getTokenSize" type="int" line="531"/>
            <method name="getTokenSize" type="int" line="536">
                <params>
                    <param name="ch" type="CipherHelper"/>
                </params>
            </method>
            <method name="getSealAlg" type="int" line="550"/>
            <javadoc line="550">
                Obtains the encryption algorithm that should be used in this token
                  given the state of confidentiality the application requested.
                  Requested qop must be consistent with negotiated session key.                
                <param>
                    confRequested true if the application desired confidentiality
                      on this token, false otherwise                    
                </param>
                <param>
                    qop the qop requested by the application                    
                </param>
                <throws>
                    GSSException if qop is incompatible with the negotiated
                      session key                    
                </throws>
            </javadoc>
            <class name="MessageTokenHeader" line="567">
                <javadoc line="567">
                    This inner class represents the initial portion of the message token
                      and contains information about the checksum and encryption algorithms
                      that are in use. It constitutes the first 8 bytes of the
                      message token:
                      &lt;pre&gt;
                      0..1           TOK_ID          Identification field.
                      01 01 - Mic token
                      02 01 - Wrap token
                      2..3           SGN_ALG         Checksum algorithm indicator.
                      00 00 - DES MAC MD5
                      01 00 - MD2.5
                      02 00 - DES MAC
                      04 00 - HMAC SHA1 DES3-KD
                      11 00 - RC4-HMAC
                      4..5           SEAL_ALG        ff ff - none
                      00 00 - DES
                      02 00 - DES3-KD
                      10 00 - RC4-HMAC
                      6..7           Filler          Contains ff ff
                      &lt;/pre&gt;                    
                </javadoc>
                <declaration name="tokenId" type="int" line="591"/>
                <declaration name="signAlg" type="int" line="592"/>
                <declaration name="sealAlg" type="int" line="593"/>
                <declaration name="bytes" type="byte[]" line="595"/>
                <javadoc line="597">
                    Constructs a MessageTokenHeader for the specified token type with
                      appropriate checksum and encryption algorithms fields.                    
                    <param>
                        tokenId the token id for this mesage token                        
                    </param>
                    <param>
                        conf true if confidentiality will be resuested with this
                          message token, false otherwise.                        
                    </param>
                    <param>
                        qop the value of the quality of protection that will be
                          desired.                        
                    </param>
                </javadoc>
                <method name="MessageTokenHeader" type="constructor" line="608">
                    <params>
                        <param name="tokenId" type="int"/>
                        <param name="conf" type="boolean"/>
                        <param name="qop" type="int"/>
                    </params>
                </method>
                <javadoc line="629">
                    Constructs a MessageTokenHeader by reading it from an InputStream
                      and sets the appropriate confidentiality and quality of protection
                      values in a MessageProp structure.                    
                    <param>
                        is the InputStream to read from                        
                    </param>
                    <param>
                        prop the MessageProp to populate                        
                    </param>
                    <throws>
                        IOException is an error occurs while reading from the
                          InputStream                        
                    </throws>
                </javadoc>
                <method name="MessageTokenHeader" type="constructor" line="640">
                    <params>
                        <param name="is" type="InputStream"/>
                        <param name="prop" type="MessageProp"/>
                    </params>
                    <comment line="646">
                        debug(&quot;\nMessageTokenHeader read tokenId=&quot; +
                                        getHexBytes(bytes) + &quot;\n&quot;);
                         XXX compare to FILLER                        
                    </comment>
                    <comment line="651">
                        debug(&quot;SIGN_ALG=&quot; + signAlg);                        
                    </comment>
                    <comment line="664">
                        default                        
                    </comment>
                    <declaration name="temp" type="int" line="648"/>
                </method>
                <javadoc line="666">
                    Encodes this MessageTokenHeader onto an OutputStream                    
                    <param>
                        os the OutputStream to write to                        
                    </param>
                    <throws>
                        IOException is an error occurs while writing                        
                    </throws>
                </javadoc>
                <method name="encode" type="void" line="671">
                    <params>
                        <param name="os" type="OutputStream"/>
                    </params>
                </method>
                <javadoc line="676">
                    Returns the token id for the message token.                    
                    <return>
                        the token id                        
                    </return>
                    <see>
                        sun.security.jgss.krb5.Krb5Token#MIC_ID                        
                    </see>
                    <see>
                        sun.security.jgss.krb5.Krb5Token#WRAP_ID                        
                    </see>
                </javadoc>
                <method name="getTokenId" type="int" line="682"/>
                <javadoc line="686">
                    Returns the sign algorithm for the message token.                    
                    <return>
                        the sign algorithm                        
                    </return>
                    <see>
                        sun.security.jgss.krb5.MessageToken#SIGN_DES_MAC                        
                    </see>
                    <see>
                        sun.security.jgss.krb5.MessageToken#SIGN_DES_MAC_MD5                        
                    </see>
                </javadoc>
                <method name="getSignAlg" type="int" line="692"/>
                <javadoc line="696">
                    Returns the seal algorithm for the message token.                    
                    <return>
                        the seal algorithm                        
                    </return>
                    <see>
                        sun.security.jgss.krb5.MessageToken#SEAL_ALG_DES                        
                    </see>
                    <see>
                        sun.security.jgss.krb5.MessageToken#SEAL_ALG_NONE                        
                    </see>
                </javadoc>
                <method name="getSealAlg" type="int" line="702"/>
                <javadoc line="706">
                    Returns the bytes of this header.                    
                    <return>
                        8 bytes that form this header                        
                    </return>
                </javadoc>
                <method name="getBytes" type="byte[]" line="710"/>
            </class>
            <javadoc line="716">
                Determine signing algorithm based on QOP.                
            </javadoc>
            <method name="getSgnAlg" type="int" line="719">
                <params>
                    <param name="qop" type="int"/>
                </params>
                <comment line="721">
                    QOP ignored                    
                </comment>
            </method>
        </class>
    </source>