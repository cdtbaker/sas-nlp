<?xml version="1.0" encoding="UTF-8"?>
    <source package="com.sun.security.sasl.digest">
        <import package="java.security.AccessController"/>
        <import package="java.security.MessageDigest"/>
        <import package="java.security.NoSuchAlgorithmException"/>
        <import package="java.io.ByteArrayOutputStream"/>
        <import package="java.io.ByteArrayInputStream"/>
        <import package="java.io.IOException"/>
        <import package="java.io.UnsupportedEncodingException"/>
        <import package="java.util.StringTokenizer"/>
        <import package="java.util.ArrayList"/>
        <import package="java.util.List"/>
        <import package="java.util.Map"/>
        <import package="java.util.Set"/>
        <import package="java.util.Arrays"/>
        <import package="java.util.logging.Logger"/>
        <import package="java.util.logging.Level"/>
        <import package="javax.security.sasl"/>
        <import package="javax.security.auth.callback.CallbackHandler"/>
        <import package="javax.security.auth.callback.PasswordCallback"/>
        <import package="javax.security.auth.callback.NameCallback"/>
        <import package="javax.security.auth.callback.Callback"/>
        <import package="javax.security.auth.callback.UnsupportedCallbackException"/>
        <class name="DigestMD5Client" line="52">
            <extends class="DigestMD5Base"/>
            <comment line="107">
                Property for specifying cipher explicitly                
            </comment>
            <comment line="111">
                                
            </comment>
            <comment line="124">
                                
            </comment>
            <comment line="135">
                number of times nonce has been used/seen                
            </comment>
            <comment line="137">
                                
            </comment>
            <comment line="138">
                cipher explicitly requested by user                
            </comment>
            <comment line="139">
                client generated nonce                
            </comment>
            <comment line="142">
                byte repr of authzid                
            </comment>
            <implements interface="SaslClient"/>
            <javadoc line="52">
                An implementation of the DIGEST-MD5
                  (&lt;a href=&quot;http://www.ietf.org/rfc/rfc2831.txt&quot;&gt;RFC 2831&lt;/a&gt;) SASL
                  (&lt;a href=&quot;http://www.ietf.org/rfc/rfc2222.txt&quot;&gt;RFC 2222&lt;/a&gt;) mechanism.
                  The DIGEST-MD5 SASL mechanism specifies two modes of authentication.
                  - Initial Authentication
                  - Subsequent Authentication - optional, (currently unsupported)
                  Required callbacks:
                  - RealmChoiceCallback
                  shows user list of realms server has offered; handler must choose one
                  from list
                  - RealmCallback
                  shows user the only realm server has offered or none; handler must
                  enter realm to use
                  - NameCallback
                  handler must enter username to use for authentication
                  - PasswordCallback
                  handler must enter password for username to use for authentication
                  Environment properties that affect behavior of implementation:
                  javax.security.sasl.qop
                  quality of protection; list of auth, auth-int, auth-conf; default is &quot;auth&quot;
                  javax.security.sasl.strength
                  auth-conf strength; list of high, medium, low; default is highest
                  available on platform [&quot;high,medium,low&quot;].
                  high means des3 or rc4 (128); medium des or rc4-56; low is rc4-40;
                  choice of cipher depends on its availablility on platform
                  javax.security.sasl.maxbuf
                  max receive buffer size; default is 65536
                  javax.security.sasl.sendmaxbuffer
                  max send buffer size; default is 65536; (min with server max recv size)
                  com.sun.security.sasl.digest.cipher
                  name a specific cipher to use; setting must be compatible with the
                  setting of the javax.security.sasl.strength property.                
                <see>
                    &lt;a href=&quot;http://www.ietf.org/rfc/rfc2222.txt&quot;&gt;RFC 2222&lt;/a&gt;
                      - Simple Authentication and Security Layer (SASL)                    
                </see>
                <see>
                    &lt;a href=&quot;http://www.ietf.org/rfc/rfc2831.txt&quot;&gt;RFC 2831&lt;/a&gt;
                      - Using Digest Authentication as a SASL Mechanism                    
                </see>
                <see>
                    &lt;a href=&quot;http://java.sun.com/products/jce&quot;&gt;Java(TM)
                       Cryptography Extension 1.2.1 (JCE)&lt;/a&gt;                    
                </see>
                <see>
                    &lt;a href=&quot;http://java.sun.com/products/jaas&quot;&gt;Java(TM)
                       Authentication and Authorization Service (JAAS)&lt;/a&gt;                    
                </see>
                <author>
                    Jonathan Bruce                    
                </author>
                <author>
                    Rosanna Lee                    
                </author>
            </javadoc>
            <declaration name="MY_CLASS_NAME" type="String" line="104"/>
            <declaration name="CIPHER_PROPERTY" type="String" line="107"/>
            <declaration name="DIRECTIVE_KEY" type="String[]" line="111"/>
            <declaration name="REALM" type="int" line="124"/>
            <declaration name="QOP" type="int" line="125"/>
            <declaration name="ALGORITHM" type="int" line="126"/>
            <declaration name="NONCE" type="int" line="127"/>
            <declaration name="MAXBUF" type="int" line="128"/>
            <declaration name="CHARSET" type="int" line="129"/>
            <declaration name="CIPHER" type="int" line="130"/>
            <declaration name="RESPONSE_AUTH" type="int" line="131"/>
            <declaration name="STALE" type="int" line="132"/>
            <declaration name="nonceCount" type="int" line="134"/>
            <declaration name="specifiedCipher" type="String" line="137"/>
            <declaration name="cnonce" type="byte[]" line="138"/>
            <declaration name="username" type="String" line="139"/>
            <declaration name="passwd" type="char[]" line="140"/>
            <declaration name="authzidBytes" type="byte[]" line="141"/>
            <javadoc line="143">
                Constructor for DIGEST-MD5 mechanism.                
                <param>
                    authzid A non-null String representing the principal
                      for which authorization is being granted..                    
                </param>
                <param>
                    digestURI A non-null String representing detailing the
                      combined protocol and host being used for authentication.                    
                </param>
                <param>
                    props The possibly null properties to be used by the SASL
                      mechanism to configure the authentication exchange.                    
                </param>
                <param>
                    cbh The non-null CallbackHanlder object for callbacks                    
                </param>
                <throws>
                    SaslException if no authentication ID or password is supplied                    
                </throws>
            </javadoc>
            <method name="DigestMD5Client" type="constructor" line="156">
                <params>
                    <param name="authzid" type="String"/>
                    <param name="protocol" type="String"/>
                    <param name="serverName" type="String"/>
                    <param name="props" type="Map"/>
                    <param name="cbh" type="CallbackHandler"/>
                </params>
                <comment line="161">
                    authzID can only be encoded in UTF8 - RFC 2222                    
                </comment>
                <scope line="161">
                    <scope line="163"/>
                    <scope line="166"/>
                </scope>
                <scope line="172"/>
            </method>
            <javadoc line="180">
                DIGEST-MD5 has no initial response                
                <return>
                    false                    
                </return>
            </javadoc>
            <method name="hasInitialResponse" type="boolean" line="185"/>
            <javadoc line="189">
                Process the challenge data.
                  The server sends a digest-challenge which the client must reply to
                  in a digest-response. When the authentication is complete, the
                  completed field is set to true.                
                <param>
                    challengeData A non-null byte array containing the challenge
                      data from the server.                    
                </param>
                <return>
                    A possibly null byte array containing the response to
                      be sent to the server.                    
                </return>
                <throws>
                    SaslException If the platform does not have MD5 digest support
                      or if the server sends an invalid challenge.                    
                </throws>
            </javadoc>
            <method name="evaluateChallenge" type="byte[]" line="204">
                <params>
                    <param name="challengeData" type="byte[]"/>
                </params>
                <comment line="213">
                                        
                </comment>
                <comment line="218">
                                        
                </comment>
                <comment line="219">
                    Get realm, qop, maxbuf, charset, algorithm, cipher, nonce                    
                </comment>
                <comment line="233">
                    rethrow                    
                </comment>
                <comment line="243">
                                        
                </comment>
                <comment line="244">
                                        
                </comment>
                <comment line="250">
                                        
                </comment>
                <comment line="252">
                                        
                </comment>
                <comment line="254">
                                        
                </comment>
                <comment line="257">
                    Mechanism has completed.                    
                </comment>
                <comment line="260">
                    Set to invalid state                    
                </comment>
                <comment line="265">
                    No other possible state                    
                </comment>
                <scope line="206"/>
                <declaration name="challengeVal" type="byte[][]" line="213"/>
                <declaration name="realmChoices" type="List&lt;byte[]&gt;" line="220"/>
                <scope line="224"/>
                <scope line="229"/>
                <scope line="233"/>
                <scope line="241">
                    <scope line="250"/>
                    <scope line="252"/>
                </scope>
                <scope line="257"/>
            </method>
            <javadoc line="270">
                Record information from the challengeVal array into variables/fields.
                  Check directive values that are multi-valued and ensure that mandatory
                  directives not missing from the digest-challenge.                
                <throws>
                    SaslException if a sasl is a the mechanism cannot
                      correcly handle a callbacks or if a violation in the
                      digest challenge format is detected.                    
                </throws>
            </javadoc>
            <method name="processChallenge" type="void" line="280">
                <params>
                    <param name="challengeVal" type="byte[][]"/>
                    <param name="realmChoices" type="List<byte[]>"/>
                </params>
                <comment line="283">
                                        
                </comment>
                <comment line="295">
                                        
                </comment>
                <comment line="305">
                                        
                </comment>
                <comment line="314">
                                        
                </comment>
                <comment line="319">
                    Only one realm specified                    
                </comment>
                <comment line="337">
                    Server specified &lt;= 1 realm
                     If 0, RFC 2831: the client SHOULD solicit a realm from the user.                    
                </comment>
                <comment line="345">
                                        
                </comment>
                <comment line="357">
                                        
                </comment>
                <comment line="379">
                                        
                </comment>
                <scope line="283">
                    <scope line="284"/>
                    <scope line="288"/>
                </scope>
                <scope line="295"/>
                <scope line="298"/>
                <scope line="305"/>
                <scope line="308"/>
                <scope line="312">
                    <declaration name="realmTokens" type="String[]" line="314"/>
                    <scope line="316">
                        <scope line="317"/>
                        <scope line="320">
                            <scope line="322"/>
                        </scope>
                    </scope>
                    <declaration name="ncb" type="NameCallback" line="329"/>
                    <declaration name="pcb" type="PasswordCallback" line="332"/>
                    <scope line="335">
                        <declaration name="tcb" type="RealmCallback" line="338"/>
                        <scope line="346"/>
                    </scope>
                    <scope line="349">
                        <declaration name="ccb" type="RealmChoiceCallback" line="350"/>
                    </scope>
                </scope>
                <scope line="364"/>
                <scope line="368"/>
                <scope line="373"/>
                <declaration name="srvMaxBufSize" type="int" line="379"/>
            </method>
            <javadoc line="387">
                Parses the &apos;qop&apos; directive. If &apos;auth-conf&apos; is specified by
                  the client and offered as a QOP option by the server, then a check
                  is client-side supported ciphers is performed.                
                <throws>
                    IOException                    
                </throws>
            </javadoc>
            <method name="checkQopSupport" type="void" line="395">
                <params>
                    <param name="qopInChallenge" type="byte[]"/>
                    <param name="ciphersInChallenge" type="byte[]"/>
                </params>
                <comment line="398">
                                        
                </comment>
                <comment line="407">
                    process                    
                </comment>
                <comment line="410">
                                        
                </comment>
                <comment line="420">
                    buffer sizes not applicable                    
                </comment>
                <declaration name="qopOptions" type="String" line="398"/>
                <scope line="400"/>
                <scope line="402"/>
                <declaration name="serverQopTokens" type="String[]" line="407"/>
                <declaration name="serverQop" type="byte[]" line="408"/>
                <declaration name="serverAllQop" type="byte" line="410"/>
                <scope line="436"/>
            </method>
            <javadoc line="442">
                Processes the &apos;cipher&apos; digest-challenge directive. This allows the
                  mechanism to check for client-side support against the list of
                  supported ciphers send by the server. If no match is found,
                  the mechanism aborts.                
                <throws>
                    SaslException If an error is encountered in processing
                      the cipher digest-challenge directive or if no client-side
                      support is found.                    
                </throws>
            </javadoc>
            <method name="checkStrengthSupport" type="void" line="453">
                <params>
                    <param name="ciphersInChallenge" type="byte[]"/>
                </params>
                <comment line="456">
                                        
                </comment>
                <comment line="462">
                    First determine ciphers that server supports                    
                </comment>
                <comment line="474">
                    Parse ciphers in challenge; mark each that server supports                    
                </comment>
                <comment line="480">
                    keep for replay to server                    
                </comment>
                <comment line="486">
                    Determine which ciphers are available on client                    
                </comment>
                <comment line="489">
                    Take intersection of server and client supported ciphers                    
                </comment>
                <comment line="502">
                    now have a clear picture of user / client; client / server
                     cipher options. Leverage strength array against what is
                     supported to choose a cipher.                    
                </comment>
                <scope line="456"/>
                <declaration name="cipherOptions" type="String" line="462"/>
                <declaration name="parser" type="StringTokenizer" line="463"/>
                <declaration name="tokenCount" type="int" line="464"/>
                <declaration name="token" type="String" line="465"/>
                <declaration name="serverCiphers" type="byte[]" line="466"/>
                <declaration name="serverCipherStrs" type="String[]" line="471"/>
                <scope line="474">
                    <scope line="476">
                        <scope line="477"/>
                    </scope>
                </scope>
                <declaration name="clntCiphers" type="byte[]" line="486"/>
                <declaration name="inter" type="byte" line="489"/>
                <scope line="490"/>
                <scope line="495"/>
                <scope line="506"/>
            </method>
            <javadoc line="513">
                Steps through the ordered &apos;strength&apos; array, and compares it with
                  the &apos;supportedCiphers&apos; array. The cipher returned represents
                  the best possible cipher based on the strength preference and the
                  available ciphers on both the server and client environments.                
                <param>
                    tokens The array of cipher tokens sent by server                    
                </param>
                <return>
                    The agreed cipher.                    
                </return>
            </javadoc>
            <method name="findCipherAndStrength" type="String" line="523">
                <params>
                    <param name="supportedCiphers" type="byte[]"/>
                    <param name="tokens" type="String[]"/>
                </params>
                <comment line="530">
                    If user explicitly requested cipher, then it
                     must be the one we choose                    
                </comment>
                <comment line="554">
                    none found                    
                </comment>
                <declaration name="s" type="byte" line="524"/>
                <scope line="525">
                    <scope line="526">
                        <scope line="527">
                            <scope line="534"/>
                        </scope>
                    </scope>
                </scope>
            </method>
            <javadoc line="556">
                Returns digest-response suitable for an initial authentication.
                  The following are qdstr-val (quoted string values) as per RFC 2831,
                  which means that any embedded quotes must be escaped.
                  realm-value
                  nonce-value
                  username-value
                  cnonce-value
                  authzid-value                
                <returns>
                    &lt;tt&gt;digest-response&lt;/tt&gt; in a byte array                    
                </returns>
                <throws>
                    SaslException if there is an error generating the
                      response value or the cnonce value.                    
                </throws>
            </javadoc>
            <method name="generateClientResponse" type="byte[]" line="570">
                <params>
                    <param name="charset" type="byte[]"/>
                </params>
                <declaration name="digestResp" type="ByteArrayOutputStream" line="572"/>
                <scope line="574"/>
                <scope line="583"/>
                <scope line="607"/>
                <scope line="614"/>
                <scope line="621"/>
                <scope line="625"/>
                <scope line="631"/>
            </method>
            <javadoc line="639">
                From RFC 2831, Section 2.1.3: Step Three
                  [Server] sends a message formatted as follows:
                  response-auth = &quot;rspauth&quot; &quot;=&quot; response-value
                  where response-value is calculated as above, using the values sent in
                  step two, except that if qop is &quot;auth&quot;, then A2 is
                  A2 = { &quot;:&quot;, digest-uri-value }
                  And if qop is &quot;auth-int&quot; or &quot;auth-conf&quot; then A2 is
                  A2 = { &quot;:&quot;, digest-uri-value, &quot;:00000000000000000000000000000000&quot; }                
            </javadoc>
            <method name="validateResponseValue" type="void" line="652">
                <params>
                    <param name="fromServer" type="byte[]"/>
                </params>
                <comment line="664">
                                        
                </comment>
                <scope line="653"/>
                <scope line="658">
                    <declaration name="expected" type="byte[]" line="659"/>
                    <scope line="662"/>
                </scope>
                <scope line="667"/>
                <scope line="670"/>
            </method>
            <javadoc line="676">
                Returns the number of requests (including current request)
                  that the client has sent in response to nonceValue.
                  This is 1 the first time nonceValue is seen.
                  We don&apos;t cache nonce values seen, and we don&apos;t support subsequent
                  authentication, so the value is always 1.                
            </javadoc>
            <method name="getNonceCount" type="int" line="684">
                <params>
                    <param name="nonceValue" type="byte[]"/>
                </params>
            </method>
            <method name="clearPassword" type="void" line="688">
                <scope line="689">
                    <scope line="690"/>
                </scope>
            </method>
        </class>
    </source>