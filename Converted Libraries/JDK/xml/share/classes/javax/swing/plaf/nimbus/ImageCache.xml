<?xml version="1.0" encoding="UTF-8"?>
    <source package="javax.swing.plaf.nimbus">
        <import package="java.awt.GraphicsConfiguration"/>
        <import package="java.awt.Image"/>
        <import package="java.lang.ref.ReferenceQueue"/>
        <import package="java.lang.ref.SoftReference"/>
        <import package="java.util.Arrays"/>
        <import package="java.util.Iterator"/>
        <import package="java.util.LinkedHashMap"/>
        <import package="java.util.Map"/>
        <import package="java.util.concurrent.locks.ReadWriteLock"/>
        <import package="java.util.concurrent.locks.ReentrantReadWriteLock"/>
        <class name="ImageCache" line="38">
            <comment line="47">
                Ordered Map keyed by args hash, ordered by most recent accessed entry.                
            </comment>
            <comment line="50">
                Maximum number of pixels to cache, this is used if maxCount                
            </comment>
            <comment line="52">
                Maximum cached image size in pxiels                
            </comment>
            <comment line="54">
                The current number of pixels stored in the cache                
            </comment>
            <comment line="56">
                Lock for concurrent access to map                
            </comment>
            <comment line="58">
                Reference queue for tracking lost softreferences to images in the cache                
            </comment>
            <comment line="60">
                Singleton Instance                
            </comment>
            <javadoc line="38">
                ImageCache - A fixed pixel count sized cache of Images keyed by arbitrary set of arguments. All images are held with
                  SoftReferences so they will be dropped by the GC if heap memory gets tight. When our size hits max pixel count least
                  recently requested images are removed first.                
                <author>
                    Created by Jasper Potts (Aug 7, 2007)                    
                </author>
            </javadoc>
            <declaration name="map" type="LinkedHashMap&lt;Integer,PixelCountSoftReference&gt;" line="47"/>
            <declaration name="maxPixelCount" type="int" line="50"/>
            <declaration name="maxSingleImagePixelSize" type="int" line="52"/>
            <declaration name="currentPixelCount" type="int" line="54"/>
            <declaration name="lock" type="ReadWriteLock" line="56"/>
            <declaration name="referenceQueue" type="ReferenceQueue&lt;Image&gt;" line="58"/>
            <declaration name="instance" type="ImageCache" line="60"/>
            <javadoc line="63">
                Get static singleton instance                
            </javadoc>
            <method name="getInstance" type="ImageCache" line="64"/>
            <method name="ImageCache" type="constructor" line="68">
                <comment line="70">
                    8Mb of pixels                    
                </comment>
            </method>
            <method name="ImageCache" type="constructor" line="73">
                <params>
                    <param name="maxPixelCount" type="int"/>
                    <param name="maxSingleImagePixelSize" type="int"/>
                </params>
            </method>
            <javadoc line="78">
                Clear the cache                
            </javadoc>
            <method name="flush" type="void" line="79">
                <scope line="81"/>
                <scope line="83"/>
            </method>
            <javadoc line="88">
                Check if the image size is to big to be stored in the cache                
                <param>
                    w The image width                    
                </param>
                <param>
                    h The image height                    
                </param>
                <return>
                    True if the image size is less than max                    
                </return>
            </javadoc>
            <method name="isImageCachable" type="boolean" line="95">
                <params>
                    <param name="w" type="int"/>
                    <param name="h" type="int"/>
                </params>
            </method>
            <javadoc line="99">
                Get the cached image for given keys                
                <param>
                    config The graphics configuration, needed if cached image is a Volatile Image. Used as part of cache key                    
                </param>
                <param>
                    w      The image width, used as part of cache key                    
                </param>
                <param>
                    h      The image height, used as part of cache key                    
                </param>
                <param>
                    args   Other arguments to use as part of the cache key                    
                </param>
                <return>
                    Returns the cached Image, or null there is no cached image for key                    
                </return>
            </javadoc>
            <method name="getImage" type="Image" line="108">
                <params>
                    <param name="config" type="GraphicsConfiguration"/>
                    <param name="w" type="int"/>
                    <param name="h" type="int"/>
                    <param name="args" type="Object"/>
                </params>
                <comment line="113">
                    check reference has not been lost and the key truly matches, in case of false positive hash match                    
                </comment>
                <scope line="110">
                    <declaration name="ref" type="PixelCountSoftReference" line="111"/>
                    <scope line="113"/>
                    <scope line="115"/>
                </scope>
                <scope line="118"/>
            </method>
            <javadoc line="123">
                Sets the cached image for the specified constraints.                
                <param>
                    image  The image to store in cache                    
                </param>
                <param>
                    config The graphics configuration, needed if cached image is a Volatile Image. Used as part of cache key                    
                </param>
                <param>
                    w      The image width, used as part of cache key                    
                </param>
                <param>
                    h      The image height, used as part of cache key                    
                </param>
                <param>
                    args   Other arguments to use as part of the cache key                    
                </param>
                <return>
                    true if the image could be cached or false if the image is too big                    
                </return>
            </javadoc>
            <method name="setImage" type="boolean" line="133">
                <params>
                    <param name="image" type="Image"/>
                    <param name="config" type="GraphicsConfiguration"/>
                    <param name="w" type="int"/>
                    <param name="h" type="int"/>
                    <param name="args" type="Object"/>
                </params>
                <comment line="140">
                    check if currently in map                    
                </comment>
                <comment line="144">
                    clear out old                    
                </comment>
                <comment line="149">
                    add new image to pixel count                    
                </comment>
                <comment line="152">
                    clean out lost references if not enough space                    
                </comment>
                <comment line="155">
                    reference lost                    
                </comment>
                <comment line="160">
                    remove old items till there is enough free space                    
                </comment>
                <comment line="171">
                    finaly put new in map                    
                </comment>
                <declaration name="hash" type="int" line="135"/>
                <scope line="137">
                    <declaration name="ref" type="PixelCountSoftReference" line="138"/>
                    <scope line="140"/>
                    <scope line="144"/>
                    <declaration name="newPixelCount" type="int" line="149"/>
                    <scope line="152">
                        <scope line="153"/>
                    </scope>
                    <scope line="160">
                        <declaration name="mapIter" type="Iterator&lt;Map.Entry&lt;Integer,PixelCountSoftReference&gt;&gt;" line="161"/>
                        <scope line="162">
                            <declaration name="entry" type="Map.Entry&lt;Integer,PixelCountSoftReference&gt;" line="163"/>
                            <declaration name="img" type="Image" line="165"/>
                        </scope>
                    </scope>
                </scope>
                <scope line="173"/>
            </method>
            <javadoc line="178">
                Create a unique hash from all the input                
            </javadoc>
            <method name="hash" type="int" line="179">
                <params>
                    <param name="config" type="GraphicsConfiguration"/>
                    <param name="w" type="int"/>
                    <param name="h" type="int"/>
                    <param name="args" type="Object"/>
                </params>
                <declaration name="hash" type="int" line="180"/>
            </method>
            <class name="PixelCountSoftReference" line="189">
                <extends class="SoftReference">
                    <type_params>
                        <type_param name="Image"/>
                    </type_params>
                </extends>
                <comment line="194">
                    key parts                    
                </comment>
                <javadoc line="189">
                    Extended SoftReference that stores the pixel count even after the image is lost                    
                </javadoc>
                <declaration name="pixelCount" type="int" line="191"/>
                <declaration name="hash" type="int" line="192"/>
                <declaration name="config" type="GraphicsConfiguration" line="194"/>
                <declaration name="w" type="int" line="195"/>
                <declaration name="h" type="int" line="196"/>
                <declaration name="args" type="Object[]" line="197"/>
                <method name="PixelCountSoftReference" type="constructor" line="200">
                    <params>
                        <param name="referent" type="Image"/>
                        <param name="q" type="ReferenceQueue<? super Image>"/>
                        <param name="pixelCount" type="int"/>
                        <param name="hash" type="int"/>
                        <param name="config" type="GraphicsConfiguration"/>
                        <param name="w" type="int"/>
                        <param name="h" type="int"/>
                        <param name="args" type="Object[]"/>
                    </params>
                </method>
                <method name="equals" type="boolean" line="210">
                    <params>
                        <param name="config" type="GraphicsConfiguration"/>
                        <param name="w" type="int"/>
                        <param name="h" type="int"/>
                        <param name="args" type="Object[]"/>
                    </params>
                </method>
            </class>
        </class>
    </source>