<?xml version="1.0" encoding="UTF-8"?>
    <source package="org.apache.commons.math3.ode.events">
        <import package="org.apache.commons.math3.analysis.UnivariateFunction"/>
        <import package="org.apache.commons.math3.analysis.solvers.AllowedSolution"/>
        <import package="org.apache.commons.math3.analysis.solvers.BracketedUnivariateSolver"/>
        <import package="org.apache.commons.math3.analysis.solvers.PegasusSolver"/>
        <import package="org.apache.commons.math3.analysis.solvers.UnivariateSolver"/>
        <import package="org.apache.commons.math3.analysis.solvers.UnivariateSolverUtils"/>
        <import package="org.apache.commons.math3.exception.MaxCountExceededException"/>
        <import package="org.apache.commons.math3.exception.NoBracketingException"/>
        <import package="org.apache.commons.math3.ode.sampling.StepInterpolator"/>
        <import package="org.apache.commons.math3.util.FastMath"/>
        <class name="EventState" line="31">
            <javadoc line="31">
                This class handles the state for one {@link EventHandlerevent handler} during integration steps.
                  &lt;p&gt;Each time the integrator proposes a step, the event handler
                  switching function should be checked. This class handles the state
                  of one handler during one integration step, with references to the
                  state at the end of the preceding step. This information is used to
                  decide if the handler should trigger an event or not during the
                  proposed step.&lt;/p&gt;                
                <version>
                    $Id: EventState.java 1416643 2012-12-03 19:37:14Z tn $                    
                </version>
                <since>
                    1.2                    
                </since>
            </javadoc>
            <declaration name="handler" type="EventHandler" line="46"/>
            <javadoc line="46">
                Event handler.                
            </javadoc>
            <declaration name="maxCheckInterval" type="double" line="49"/>
            <javadoc line="49">
                Maximal time interval between events handler checks.                
            </javadoc>
            <declaration name="convergence" type="double" line="52"/>
            <javadoc line="52">
                Convergence threshold for event localization.                
            </javadoc>
            <declaration name="maxIterationCount" type="int" line="55"/>
            <javadoc line="55">
                Upper limit in the iteration count for event localization.                
            </javadoc>
            <declaration name="t0" type="double" line="58"/>
            <javadoc line="58">
                Time at the beginning of the step.                
            </javadoc>
            <declaration name="g0" type="double" line="61"/>
            <javadoc line="61">
                Value of the events handler at the beginning of the step.                
            </javadoc>
            <declaration name="g0Positive" type="boolean" line="64"/>
            <javadoc line="64">
                Simulated sign of g0 (we cheat when crossing events).                
            </javadoc>
            <declaration name="pendingEvent" type="boolean" line="67"/>
            <javadoc line="67">
                Indicator of event expected during the step.                
            </javadoc>
            <declaration name="pendingEventTime" type="double" line="70"/>
            <javadoc line="70">
                Occurrence time of the pending event.                
            </javadoc>
            <declaration name="previousEventTime" type="double" line="73"/>
            <javadoc line="73">
                Occurrence time of the previous event.                
            </javadoc>
            <declaration name="forward" type="boolean" line="76"/>
            <javadoc line="76">
                Integration direction.                
            </javadoc>
            <declaration name="increasing" type="boolean" line="79"/>
            <javadoc line="79">
                Variation direction around pending event.
                  (this is considered with respect to the integration direction)                
            </javadoc>
            <declaration name="nextAction" type="EventHandler.Action" line="84"/>
            <javadoc line="84">
                Next action indicator.                
            </javadoc>
            <declaration name="solver" type="UnivariateSolver" line="87"/>
            <javadoc line="87">
                Root-finding algorithm to use to detect state events.                
            </javadoc>
            <javadoc line="90">
                Simple constructor.                
                <param>
                    handler event handler                    
                </param>
                <param>
                    maxCheckInterval maximal time interval between switching
                      function checks (this interval prevents missing sign changes in
                      case the integration steps becomes very large)                    
                </param>
                <param>
                    convergence convergence threshold in the event time search                    
                </param>
                <param>
                    maxIterationCount upper limit of the iteration count in
                      the event time search                    
                </param>
                <param>
                    solver Root-finding algorithm to use to detect state events                    
                </param>
            </javadoc>
            <method name="EventState" type="constructor" line="102">
                <params>
                    <param name="handler" type="EventHandler"/>
                    <param name="maxCheckInterval" type="double"/>
                    <param name="convergence" type="double"/>
                    <param name="maxIterationCount" type="int"/>
                    <param name="solver" type="UnivariateSolver"/>
                </params>
                <comment line="109">
                    some dummy values ...                    
                </comment>
            </method>
            <javadoc line="121">
                Get the underlying event handler.                
                <return>
                    underlying event handler                    
                </return>
            </javadoc>
            <method name="getEventHandler" type="EventHandler" line="124"/>
            <javadoc line="128">
                Get the maximal time interval between events handler checks.                
                <return>
                    maximal time interval between events handler checks                    
                </return>
            </javadoc>
            <method name="getMaxCheckInterval" type="double" line="131"/>
            <javadoc line="135">
                Get the convergence threshold for event localization.                
                <return>
                    convergence threshold for event localization                    
                </return>
            </javadoc>
            <method name="getConvergence" type="double" line="138"/>
            <javadoc line="142">
                Get the upper limit in the iteration count for event localization.                
                <return>
                    upper limit in the iteration count for event localization                    
                </return>
            </javadoc>
            <method name="getMaxIterationCount" type="int" line="145"/>
            <javadoc line="149">
                Reinitialize the beginning of the step.                
                <param>
                    interpolator valid for the current step                    
                </param>
                <exception>
                    MaxCountExceededException if the interpolator throws one because
                      the number of functions evaluations is exceeded                    
                </exception>
            </javadoc>
            <method name="reinitializeBegin" type="void" line="155">
                <params>
                    <param name="interpolator" type="StepInterpolator"/>
                </params>
                <comment line="161">
                    excerpt from MATH-421 issue:                    
                </comment>
                <comment line="162">
                    If an ODE solver is setup with an EventHandler that return STOP                    
                </comment>
                <comment line="163">
                    when the even is triggered, the integrator stops (which is exactly                    
                </comment>
                <comment line="164">
                    the expected behavior). If however the user wants to restart the                    
                </comment>
                <comment line="165">
                    solver from the final state reached at the event with the same                    
                </comment>
                <comment line="166">
                    configuration (expecting the event to be triggered again at a                    
                </comment>
                <comment line="167">
                    later time), then the integrator may fail to start. It can get stuck                    
                </comment>
                <comment line="168">
                    at the previous event. The use case for the bug MATH-421 is fairly                    
                </comment>
                <comment line="169">
                    general, so events occurring exactly at start in the first step should                    
                </comment>
                <comment line="170">
                    be ignored.                    
                </comment>
                <comment line="172">
                    extremely rare case: there is a zero EXACTLY at interval start                    
                </comment>
                <comment line="173">
                    we will use the sign slightly after step beginning to force ignoring this zero                    
                </comment>
                <scope line="160">
                    <declaration name="epsilon" type="double" line="174"/>
                    <declaration name="tStart" type="double" line="176"/>
                </scope>
            </method>
            <javadoc line="184">
                Evaluate the impact of the proposed step on the event handler.                
                <param>
                    interpolator step interpolator for the proposed step                    
                </param>
                <return>
                    true if the event handler triggers an event before
                      the end of the proposed step                    
                </return>
                <exception>
                    MaxCountExceededException if the interpolator throws one because
                      the number of functions evaluations is exceeded                    
                </exception>
                <exception>
                    NoBracketingException if the event cannot be bracketed                    
                </exception>
            </javadoc>
            <method name="evaluateStep" type="boolean" line="193">
                <params>
                    <param name="interpolator" type="StepInterpolator"/>
                </params>
                <comment line="200">
                    we cannot do anything on such a small step, don&apos;t trigger any events                    
                </comment>
                <comment line="221">
                    evaluate handler value at the end of the substep                    
                </comment>
                <comment line="226">
                    check events occurrence                    
                </comment>
                <comment line="228">
                    there is a sign change: an event is expected during this step                    
                </comment>
                <comment line="230">
                    variation direction, with respect to the integration direction                    
                </comment>
                <comment line="233">
                    find the event time making sure we select a solution just at or past the exact root                    
                </comment>
                <comment line="259">
                    we have either found nothing or found (again ?) a past event,                    
                </comment>
                <comment line="260">
                    retry the substep excluding this value                    
                </comment>
                <comment line="270">
                    no sign change: there is no event for now                    
                </comment>
                <comment line="276">
                    no sign change: there is no event for now                    
                </comment>
                <comment line="283">
                    no event during the whole step                    
                </comment>
                <scope line="195">
                    <declaration name="t1" type="double" line="197"/>
                    <declaration name="dt" type="double" line="198"/>
                    <scope line="199"/>
                    <declaration name="n" type="int" line="203"/>
                    <declaration name="h" type="double" line="204"/>
                    <anonymous_class line="206">
                        <method name="value" type="double" line="207">
                            <params>
                                <param name="t" type="double"/>
                            </params>
                            <scope line="208"/>
                            <scope line="211"/>
                        </method>
                    </anonymous_class>
                    <declaration name="f" type="UnivariateFunction" line="206"/>
                    <declaration name="ta" type="double" line="217"/>
                    <declaration name="ga" type="double" line="218"/>
                    <scope line="219">
                        <declaration name="tb" type="double" line="222"/>
                        <declaration name="gb" type="double" line="224"/>
                        <scope line="227">
                            <declaration name="root" type="double" line="234"/>
                            <scope line="235">
                                <declaration name="bracketing" type="BracketedUnivariateSolver&lt;UnivariateFunction&gt;" line="236"/>
                            </scope>
                            <scope line="242">
                                <declaration name="baseRoot" type="double" line="243"/>
                                <declaration name="remainingEval" type="int" line="246"/>
                                <declaration name="bracketing" type="BracketedUnivariateSolver&lt;UnivariateFunction&gt;" line="247"/>
                            </scope>
                            <scope line="258"/>
                            <scope line="265"/>
                            <scope line="269"/>
                        </scope>
                        <scope line="275"/>
                    </scope>
                </scope>
                <scope line="288"/>
            </method>
            <javadoc line="294">
                Get the occurrence time of the event triggered in the current step.                
                <return>
                    occurrence time of the event triggered in the current
                      step or infinity if no events are triggered                    
                </return>
            </javadoc>
            <method name="getEventTime" type="double" line="298"/>
            <javadoc line="304">
                Acknowledge the fact the step has been accepted by the integrator.                
                <param>
                    t value of the independent <i>time</i> variable at the
                      end of the step                    
                </param>
                <param>
                    y array containing the current value of the state vector
                      at the end of the step                    
                </param>
            </javadoc>
            <method name="stepAccepted" type="void" line="310">
                <params>
                    <param name="t" type="double"/>
                    <param name="y" type="double[]"/>
                </params>
                <comment line="316">
                    force the sign to its value &quot;just after the event&quot;                    
                </comment>
                <scope line="315"/>
                <scope line="320"/>
            </method>
            <javadoc line="326">
                Check if the integration should be stopped at the end of the
                  current step.                
                <return>
                    true if the integration should be stopped                    
                </return>
            </javadoc>
            <method name="stop" type="boolean" line="330"/>
            <javadoc line="334">
                Let the event handler reset the state if it wants.                
                <param>
                    t value of the independent <i>time</i> variable at the
                      beginning of the next step                    
                </param>
                <param>
                    y array were to put the desired state vector at the beginning
                      of the next step                    
                </param>
                <return>
                    true if the integrator should reset the derivatives too                    
                </return>
            </javadoc>
            <method name="reset" type="boolean" line="341">
                <params>
                    <param name="t" type="double"/>
                    <param name="y" type="double[]"/>
                </params>
                <scope line="343"/>
                <scope line="347"/>
            </method>
            <class name="LocalMaxCountExceededException" line="358">
                <extends class="RuntimeException"/>
                <javadoc line="358">
                    Local wrapper to propagate exceptions.                    
                </javadoc>
                <declaration name="serialVersionUID" type="long" line="361"/>
                <javadoc line="361">
                    Serializable UID.                    
                </javadoc>
                <declaration name="wrapped" type="MaxCountExceededException" line="364"/>
                <javadoc line="364">
                    Wrapped exception.                    
                </javadoc>
                <javadoc line="367">
                    Simple constructor.                    
                    <param>
                        exception exception to wrap                        
                    </param>
                </javadoc>
                <method name="LocalMaxCountExceededException" type="constructor" line="370">
                    <params>
                        <param name="exception" type="MaxCountExceededException"/>
                    </params>
                </method>
                <javadoc line="374">
                    Get the wrapped exception.                    
                    <return>
                        wrapped exception                        
                    </return>
                </javadoc>
                <method name="getException" type="MaxCountExceededException" line="377"/>
            </class>
        </class>
    </source>