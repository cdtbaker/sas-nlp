<?xml version="1.0" encoding="UTF-8"?>
    <source package="org.apache.commons.math3.analysis.differentiation">
        <import package="java.io.Serializable"/>
        <import package="org.apache.commons.math3.analysis.UnivariateFunction"/>
        <import package="org.apache.commons.math3.analysis.UnivariateMatrixFunction"/>
        <import package="org.apache.commons.math3.analysis.UnivariateVectorFunction"/>
        <import package="org.apache.commons.math3.exception.MathIllegalArgumentException"/>
        <import package="org.apache.commons.math3.exception.NotPositiveException"/>
        <import package="org.apache.commons.math3.exception.NumberIsTooLargeException"/>
        <import package="org.apache.commons.math3.exception.NumberIsTooSmallException"/>
        <import package="org.apache.commons.math3.util.FastMath"/>
        <class name="FiniteDifferencesDifferentiator" line="30">
            <implements interface="UnivariateFunctionDifferentiator"/>
            <implements interface="UnivariateVectorFunctionDifferentiator"/>
            <implements interface="UnivariateMatrixFunctionDifferentiator"/>
            <implements interface="Serializable"/>
            <javadoc line="30">
                Univariate functions differentiator using finite differences.
                  &lt;p&gt;
                  This class creates some wrapper objects around regular{@link UnivariateFunction univariate functions} (or {@link UnivariateVectorFunction univariate vector functions} or {@link UnivariateMatrixFunction univariate matrix functions}). These
                  wrapper objects compute derivatives in addition to function
                  value.
                  &lt;/p&gt;
                  &lt;p&gt;
                  The wrapper objects work by calling the underlying function on
                  a sampling grid around the current point and performing polynomial
                  interpolation. A finite differences scheme with n points is
                  theoretically able to compute derivatives up to order n-1, but
                  it is generally better to have a slight margin. The step size must
                  also be small enough in order for the polynomial approximation to
                  be good in the current point neighborhood, but it should not be too
                  small because numerical instability appears quickly (there are several
                  differences of close points). Choosing the number of points and
                  the step size is highly problem dependent.
                  &lt;/p&gt;
                  &lt;p&gt;
                  As an example of good and bad settings, lets consider the quintic
                  polynomial function {@code f(x) = (x-1)(x-0.5)x(x+0.5)(x+1)}.
                  Since it is a polynomial, finite differences with at least 6 points
                  should theoretically recover the exact same polynomial and hence
                  compute accurate derivatives for any order. However, due to numerical
                  errors, we get the following results for a 7 points finite differences
                  for abscissae in the [-10, 10] range:
                  &lt;ul&gt;
                  &lt;li&gt;step size = 0.25, second order derivative error about 9.97e-10&lt;/li&gt;
                  &lt;li&gt;step size = 0.25, fourth order derivative error about 5.43e-8&lt;/li&gt;
                  &lt;li&gt;step size = 1.0e-6, second order derivative error about 148&lt;/li&gt;
                  &lt;li&gt;step size = 1.0e-6, fourth order derivative error about 6.35e+14&lt;/li&gt;
                  &lt;/ul&gt;
                  This example shows that the small step size is really bad, even simply
                  for second order derivative!
                  &lt;/p&gt;                
                <@version>
                    n $Id: FiniteDifferencesDifferentiator.java 1420666 2012-12-12 13:33:20Z erans $                    
                </@version>
                <@since>
                    e 3.1                    
                </@since>
            </javadoc>
            <declaration name="serialVersionUID" type="long" line="75"/>
            <javadoc line="75">
                Serializable UID.                
            </javadoc>
            <declaration name="nbPoints" type="int" line="78"/>
            <javadoc line="78">
                Number of points to use.                
            </javadoc>
            <declaration name="stepSize" type="double" line="81"/>
            <javadoc line="81">
                Step size.                
            </javadoc>
            <declaration name="halfSampleSpan" type="double" line="84"/>
            <javadoc line="84">
                Half sample span.                
            </javadoc>
            <declaration name="tMin" type="double" line="87"/>
            <javadoc line="87">
                Lower bound for independent variable.                
            </javadoc>
            <declaration name="tMax" type="double" line="90"/>
            <javadoc line="90">
                Upper bound for independent variable.                
            </javadoc>
            <javadoc line="93">
                Build a differentiator with number of points and step size when independent variable is unbounded.
                  &lt;p&gt;
                  Beware that wrong settings for the finite differences differentiator
                  can lead to highly unstable and inaccurate results, especially for
                  high derivation orders. Using very small step sizes is often a
                  &lt;em&gt;bad&lt;/em&gt; idea.
                  &lt;/p&gt;                
                <@param>
                    m nbPoints number of points to use                    
                </@param>
                <@param>
                    m stepSize step size (gap between each point)                    
                </@param>
                <@exception>
                    n NotPositiveException if {@code stepsize <= 0} (note that{@link NotPositiveException} extends {@link NumberIsTooSmallException})                    
                </@exception>
                <@exception>
                    n NumberIsTooSmallException {@code nbPoint <= 1}                    
                </@exception>
            </javadoc>
            <method name="FiniteDifferencesDifferentiator" type="constructor" line="108">
                <params>
                    <param name="nbPoints" type="int"/>
                    <param name="stepSize" type="double"/>
                </params>
            </method>
            <javadoc line="112">
                Build a differentiator with number of points and step size when independent variable is bounded.
                  &lt;p&gt;
                  When the independent variable is bounded (tLower &amp;lt; t &amp;lt; tUpper), the sampling
                  points used for differentiation will be adapted to ensure the constraint holds
                  even near the boundaries. This means the sample will not be centered anymore in
                  these cases. At an extreme case, computing derivatives exactly at the lower bound
                  will lead the sample to be entirely on the right side of the derivation point.
                  &lt;/p&gt;
                  &lt;p&gt;
                  Note that the boundaries are considered to be excluded for function evaluation.
                  &lt;/p&gt;
                  &lt;p&gt;
                  Beware that wrong settings for the finite differences differentiator
                  can lead to highly unstable and inaccurate results, especially for
                  high derivation orders. Using very small step sizes is often a
                  &lt;em&gt;bad&lt;/em&gt; idea.
                  &lt;/p&gt;                
                <@param>
                    m nbPoints number of points to use                    
                </@param>
                <@param>
                    m stepSize step size (gap between each point)                    
                </@param>
                <@param>
                    m tLower lower bound for independent variable (may be {@code Double.NEGATIVE_INFINITY}if there are no lower bounds)                    
                </@param>
                <@param>
                    m tUpper upper bound for independent variable (may be {@code Double.POSITIVE_INFINITY}if there are no upper bounds)                    
                </@param>
                <@exception>
                    n NotPositiveException if {@code stepsize <= 0} (note that{@link NotPositiveException} extends {@link NumberIsTooSmallException})                    
                </@exception>
                <@exception>
                    n NumberIsTooSmallException {@code nbPoint <= 1}                    
                </@exception>
                <@exception>
                    n NumberIsTooLargeException {@code stepSize  (nbPoints - 1) >= tUpper - tLower}                    
                </@exception>
            </javadoc>
            <method name="FiniteDifferencesDifferentiator" type="constructor" line="143">
                <params>
                    <param name="nbPoints" type="int"/>
                    <param name="stepSize" type="double"/>
                    <param name="tLower" type="double"/>
                    <param name="tUpper" type="double"/>
                </params>
                <scope line="145"/>
                <scope line="150"/>
                <scope line="156"/>
                <declaration name="safety" type="double" line="159"/>
            </method>
            <javadoc line="165">
                Get the number of points to use.                
                <@return>
                    n number of points to use                    
                </@return>
            </javadoc>
            <method name="getNbPoints" type="int" line="169"/>
            <javadoc line="173">
                Get the step size.                
                <@return>
                    n step size                    
                </@return>
            </javadoc>
            <method name="getStepSize" type="double" line="177"/>
            <javadoc line="181">
                Evaluate derivatives from a sample.
                  &lt;p&gt;
                  Evaluation is done using divided differences.
                  &lt;/p&gt;                
                <@param>
                    m t evaluation abscissa value and derivatives                    
                </@param>
                <@param>
                    m t0 first sample point abscissa                    
                </@param>
                <@param>
                    m y function values sample {@code y[i] = f(t[i]) = f(t0 + i  stepSize)}                    
                </@param>
                <@return>
                    n value and derivatives at {@code t}                    
                </@return>
                <@exception>
                    n NumberIsTooLargeException if the requested derivation order
                      is larger or equal to the number of points                    
                </@exception>
            </javadoc>
            <method name="evaluate" type="DerivativeStructure" line="195">
                <params>
                    <param name="t" type="DerivativeStructure"/>
                    <param name="t0" type="double"/>
                    <param name="y" type="double[]"/>
                </params>
                <comment line="196">
                    create divided differences diagonal arrays                    
                </comment>
                <comment line="196">
                    evaluate interpolation polynomial (represented by top diagonal) at t                    
                </comment>
                <declaration name="top" type="double[]" line="198"/>
                <declaration name="bottom" type="double[]" line="199"/>
                <scope line="201">
                    <scope line="205"/>
                </scope>
                <declaration name="order" type="int" line="215"/>
                <declaration name="parameters" type="int" line="216"/>
                <declaration name="derivatives" type="double[]" line="217"/>
                <declaration name="dt0" type="double" line="218"/>
                <declaration name="interpolation" type="DerivativeStructure" line="219"/>
                <declaration name="monomial" type="DerivativeStructure" line="220"/>
                <scope line="221">
                    <scope line="222"/>
                    <scope line="225">
                        <declaration name="deltaX" type="DerivativeStructure" line="228"/>
                    </scope>
                </scope>
            </method>
            <javadoc line="238">
                {@inheritDoc}&lt;p&gt;The returned object cannot compute derivatives to arbitrary orders. The
                  value function will throw a {@link NumberIsTooLargeException} if the requested
                  derivation order is larger or equal to the number of points.
                  &lt;/p&gt;                
            </javadoc>
            <method name="differentiate" type="UnivariateDifferentiableFunction" line="244">
                <params>
                    <param name="function" type="UnivariateFunction"/>
                </params>
                <anonymous_class line="245">
                    <javadoc line="247">
                        {@inheritDoc}                        
                    </javadoc>
                    <method name="value" type="double" line="248">
                        <params>
                            <param name="x" type="double"/>
                        </params>
                    </method>
                    <javadoc line="252">
                        {@inheritDoc}                        
                    </javadoc>
                    <method name="value" type="DerivativeStructure" line="254">
                        <params>
                            <param name="t" type="DerivativeStructure"/>
                        </params>
                        <comment line="255">
                            check we can achieve the requested derivation order with the sample                            
                        </comment>
                        <comment line="255">
                            compute sample position, trying to be centered if possible                            
                        </comment>
                        <comment line="255">
                            compute sample points                            
                        </comment>
                        <comment line="255">
                            evaluate derivatives                            
                        </comment>
                        <scope line="257"/>
                        <declaration name="t0" type="double" line="262"/>
                        <declaration name="y" type="double[]" line="265"/>
                        <scope line="266"/>
                    </method>
                </anonymous_class>
            </method>
            <javadoc line="278">
                {@inheritDoc}&lt;p&gt;The returned object cannot compute derivatives to arbitrary orders. The
                  value function will throw a {@link NumberIsTooLargeException} if the requested
                  derivation order is larger or equal to the number of points.
                  &lt;/p&gt;                
            </javadoc>
            <method name="differentiate" type="UnivariateDifferentiableVectorFunction" line="284">
                <params>
                    <param name="function" type="UnivariateVectorFunction"/>
                </params>
                <anonymous_class line="285">
                    <javadoc line="287">
                        {@inheritDoc}                        
                    </javadoc>
                    <method name="value" type="double[]" line="288">
                        <params>
                            <param name="x" type="double"/>
                        </params>
                    </method>
                    <javadoc line="292">
                        {@inheritDoc}                        
                    </javadoc>
                    <method name="value" type="DerivativeStructure[]" line="294">
                        <params>
                            <param name="t" type="DerivativeStructure"/>
                        </params>
                        <comment line="295">
                            check we can achieve the requested derivation order with the sample                            
                        </comment>
                        <comment line="295">
                            compute sample position, trying to be centered if possible                            
                        </comment>
                        <comment line="295">
                            compute sample points                            
                        </comment>
                        <comment line="295">
                            evaluate derivatives                            
                        </comment>
                        <scope line="297"/>
                        <declaration name="t0" type="double" line="302"/>
                        <declaration name="y" type="double[][]" line="305"/>
                        <scope line="306">
                            <declaration name="v" type="double[]" line="307"/>
                            <scope line="308"/>
                            <scope line="311"/>
                        </scope>
                        <declaration name="value" type="DerivativeStructure[]" line="317"/>
                        <scope line="318"/>
                    </method>
                </anonymous_class>
            </method>
            <javadoc line="329">
                {@inheritDoc}&lt;p&gt;The returned object cannot compute derivatives to arbitrary orders. The
                  value function will throw a {@link NumberIsTooLargeException} if the requested
                  derivation order is larger or equal to the number of points.
                  &lt;/p&gt;                
            </javadoc>
            <method name="differentiate" type="UnivariateDifferentiableMatrixFunction" line="335">
                <params>
                    <param name="function" type="UnivariateMatrixFunction"/>
                </params>
                <anonymous_class line="336">
                    <javadoc line="338">
                        {@inheritDoc}                        
                    </javadoc>
                    <method name="value" type="double[][]" line="339">
                        <params>
                            <param name="x" type="double"/>
                        </params>
                    </method>
                    <javadoc line="343">
                        {@inheritDoc}                        
                    </javadoc>
                    <method name="value" type="DerivativeStructure[][]" line="345">
                        <params>
                            <param name="t" type="DerivativeStructure"/>
                        </params>
                        <comment line="346">
                            check we can achieve the requested derivation order with the sample                            
                        </comment>
                        <comment line="346">
                            compute sample position, trying to be centered if possible                            
                        </comment>
                        <comment line="346">
                            compute sample points                            
                        </comment>
                        <comment line="346">
                            evaluate derivatives                            
                        </comment>
                        <scope line="348"/>
                        <declaration name="t0" type="double" line="353"/>
                        <declaration name="y" type="double[][][]" line="356"/>
                        <scope line="357">
                            <declaration name="v" type="double[][]" line="358"/>
                            <scope line="359"/>
                            <scope line="362">
                                <scope line="363"/>
                            </scope>
                        </scope>
                        <declaration name="value" type="DerivativeStructure[][]" line="370"/>
                        <scope line="371">
                            <scope line="372"/>
                        </scope>
                    </method>
                </anonymous_class>
            </method>
        </class>
    </source>